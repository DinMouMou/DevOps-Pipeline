---

  - name: Ensure python is installed in remote machine
    raw: test -e /usr/bin/python || (sudo apt -y update && sudo apt install -y python-minimal)

  # - name: Install MongoDB Repository keys
  #   apt_key: state=present keyserver=keyserver.ubuntu.com id=7F0CEB10

  # - name: Install MongoDB repository
  #   apt_repository:
  #       repo: 'deb http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.0 multiverse' 
  #       state: present

  - name: Install necessary dependencies
    apt: 
        name: "{{ item }}"
        state: present
        update_cache: true
    with_items:
        - mongodb-org
        - nginx
        - nodejs
        - git
        - npm
        - unzip
        - python-pip
        - nodejs-legacy
  - name: Install python packages
    pip:
      name: pymongo
  # - name: Start MongoDB 
  #   service: name=mongod state=restarted

  - name: Download the file and untar
    unarchive:
      src: https://github.com/chrisparnin/checkbox.io/archive/master.zip
      dest: /tmp/
      remote_src: yes
  
  - name: Copy static resources to target
    shell: cp -r /tmp/checkbox.io-master/public_html/* /usr/share/nginx/html

  - name: Create mongoDB user 
    mongodb_user:
      database: burgers
      name: bob
      password: 12345
      state: present

  - name: Create Environmental Variables
    lineinfile:
      path: /etc/environment
      line: '{{item}}'
    with_items:
      - MONGO_IP=127.0.0.1
      - MONGO_PORT=27017
      - MONGO_USER=bob
      - MONGO_PASSWORD=12345
      - MAIL_USER=bob
      - MAIL_PASSWORD=666
      - MAIL_SMTP=smtp.ncsu.edu

  - name: Run npm install
    shell: npm install
    args:
      chdir: /tmp/checkbox.io-master/server-side/site

  - name: Run node server
    shell: node server.js >/dev/null 2>&1 &
    async: 10
    args:
      chdir: /tmp/checkbox.io-master/server-side/site