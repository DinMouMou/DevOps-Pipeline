---

  - name: Install build dependencies
    apt: 
      name: "{{ item }}"
      state: present
    with_items:
      - maven
      - python-jenkins
      - python-lxml
      - unzip

  # - name: Set NCSU Git credentials
  #   template: 
  #     src: credentials.xml.j2
  #     dest: /var/lib/jenkins/credentials.xml
  #     force: yes
  #     mode: 0644

  - name: Create credentials
    raw: "curl -H $(curl -s 'http://{{ inventory_hostname }}:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)') -X POST 'http://{{ inventory_hostname }}:8080/credentials/store/system/domain/_/createCredentials' \
         --data-urlencode 'json={
          \"\": \"0\",
          \"credentials\": {
            \"scope\": \"GLOBAL\",
            \"id\": \"{{ cred_id }}\",
            \"username\": \"dding3\",
            \"password\": \"1990O22&ddD\",
            \"description\": \"\",
            \"$class\": \"com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl\"
          }
        }'"

  - name: Setup iTrust build job
    jenkins_job:
      name: iTrust
      state: present
      config: "{{ lookup('template', 'templates/iTrust.config.xml.j2') }}"

  - name: Setup iTrust Fuzzer build job
    jenkins_job:
      name: iTrust-Fuzzer
      state: present
      config: "{{ lookup('template', 'templates/iTrust_Fuzzer.config.xml.j2') }}"

  - name: Creates directory
    file: 
      path: "{{ deploy_path }}/deployment"
      state: directory
      mode: 0755

  - include: install_tomcat.yml

  - include: install_mysql.yml

  - include: post_build.yml
  